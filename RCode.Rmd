---
title: "ITTF Dataset Exploration"
author: "KF"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(
	echo=TRUE,
	message=FALSE,
	warning=FALSE,
	eval=TRUE
)
```

## Background

These datasets were obtained from [Kaggle](https://www.kaggle.com/datasets/romanzdk/ittf-table-tennis-player-rankings-and-information) and shows the ITTF rankings of players between the years 2001-2020.

My plan:

1. Import dataset

1. Exploratory Data Analysis

    - distributions
    - anything else that is interesting?
  
1. Which playing style is most popular? Least popular?

As a table tennis player myself, my ulterior motive is to see which playing style I should try to give my opponents the most headaches. Read this as: least common/rare playing styles.

## Import

Here, I start off by importing the necessary packages and dataset. ***Note***: KF.QoL is a custom package I wrote that contains custom functions I wrote to improve my coding/analysis quality of life.

### Packages + Functions

```{r}
#Core packages/functions
gc()
library(KF.QoL)
library(tidyverse)
# library(data.table)
# library(readxl)

#Additional packages
library(bslib)
```

## Player Info Dataset

~~Since I expect the dataset to have a large number of rows, I will be using data.table to read in the csv files.~~

```{r}
player_info <- KF.QoL::soleImport("~/Desktop/KaggleData/ITTF/ittf_player_info.csv")
```

### EDA

When taking a first look at the data, I notice some players have "-" for one or more of the following:

1. Playing hand
1. Playing style
1. Grip

As such, I want to take a closer look at the type of missingness this is. To simplify things, I am filtering for the rows I am interested in (have "-" in at least 1 of the 3 listed variables).

```{r}
info_temp <- player_info %>% filter(`Playing hand`=="-"|`Playing style`=="-"|`Grip`=="-")
```

The number of rows went from `r nrow(player_info)` to `r nrow(info_temp)`.

```{r}
#go over all vars (except Player ID & Name) to print out unique values
numLvls <- lapply(names(info_temp)[-(1:2)],function(x){
  (unique(info_temp[[x]]))
})

#add names (to avoid any confusions)
names(numLvls) <- names(info_temp)[-(1:2)]
```

From this result, I all aspects of the player's style is unknown. A large number:

`r unique(numLvls[["Assoc"]])` 

of Associations are represented. Males and Females are represented. A wide range of birth years are represented. But, there is at least one instance of NA and "0". Players that are `r unique(numLvls[["Activity"]])` are represented.

#### Questions I have (for this subset of data):

- What is the difference between "-" and NA for the player's style? Are they the same?
- What does "^^" next to name mean?
  - How many have that?
- Which years are not represented here?
  - Is it due to players not being born on that year?
  - Or is there a hidden correlation?
- What is distribution on: gender, association, activity

#### Plotting Distributions

```{r}
#list of vars I want to view distribution of
varOfInterest <- names(numLvls)[1:4]

#print out all 4 plots using custom function
lapply(varOfInterest,function(varName){
  ggplot(info_temp,aes(info_temp[[varName]]))+ #removed ,fill=info_temp[[varName]]
    geom_bar(stat="count")+
    labs(title=varName,x="Unique Levels",y="Count")+
    theme(axis.text.x=element_text(angle=90))
})

rm(numLvls,varOfInterest)
```

Note: I chose to not use color/fill because it caused loading issues. Will have to fix/create plot for "Association" col.

From the output histograms, those that have "-" listed as their style:

- 2 associations have > 50 players
- Males > Females
- ~150 for Birth year = 0, <10 for Birth year = NA
- majority are born in early 2000s
- significant portion Active compared to Inactive

Other question(s) that arose:

- How were the data collected?
- How many are sponsored players?
  - sponsored players are more likely to disclose their equipment
- Does ranking explain this?
- How about social media presence?
  - somewhat correlated to being a sponsored player

#### Players whose style is NA

```{r}
info_na <- player_info %>% filter(is.na(`Playing hand`)|is.na(`Playing style`)|is.na(`Grip`))
```

A very large number of rows `r nrow(info_na)` have NA for 1+ aspect of their playing style. In fact, all entries for these 3 columns are NA!

I will be applying the same workflow from above to this version:

```{r}
#skipped for now
```

## Removed "-" and NA

```{r}
#using anti_join and %>%
player_info_v1 <- player_info %>% anti_join(info_na,by=c("Player ID","Name")) %>%
                    anti_join(info_temp,by=c("Player ID","Name"))
```

```{r}
#view birth year=0
player_info_yr0 <- player_info_v1 %>% filter(`Birth year`==0)

#rm those w/ 
player_info_v1 <- anti_join(player_info_v1,player_info_yr0,by=c("Player ID","Name"))
```

`r unique(player_info_yr0$Assoc)`

Taking a look at the associations, I notice the majority were from smaller countries. Of course, there are some exceptions, such as: France and Sweden.

At this point, I have done cleaning the `Player Info` dataset and will move onto the men's rankings dataset.

```{r}
#rm vars
rm(info_na,info_temp,player_info,player_info_yr0)
```

## Men's Rankings Dataset

```{r}
rankings_m <- KF.QoL::soleImport("~/Desktop/KaggleData/ITTF/ittf_rankings.csv")

#all rows for PreviousPoints & WeekNum=0 (removed)
rankings_m <- rankings_m %>% select(-c("Previous Points","WeekNum"))
```

The rankings dataset can first be split by year. I might consider splitting by month or week later on.

```{r}
#by year
male_rankings <- split(rankings_m,rankings_m$YearNum)

#by month (within year)
for(i in 1:length(male_rankings)){
  temp_df <- male_rankings[[i]]
  male_rankings[[as.character(names(male_rankings)[i])]] <- split(temp_df,temp_df$MonthNum)
}

#find years where there are less than 12 months of data 
months_present <- unlist(lapply(male_rankings,length))

rm(rankings_m)
```

While there is data for all 12 months for most years, there are 3 with 11 months, 1 with 2 months, and 2 with 1 month.

2009,2019,2020 were abnormalities that occurred due to pandemics: swine-flu for 2009 and COVID-19 for 2019,2020


